<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğrenci Listesi Çıkarıcı</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- PDF.js kütüphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
    <style>
        body {
            padding-top: 2rem;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .table {
            margin-bottom: 0;
        }
        .hidden {
            display: none;
        }
        .copy-btn {
            cursor: pointer;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        #upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        #upload-area:hover, #upload-area.dragover {
            border-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        #error-message {
            color: #dc3545;
        }
        .class-title {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 0;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .copy-class-btn {
            float: right;
            margin-top: -5px;
        }
        .debug-info {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Öğrenci Listesi Çıkarıcı</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <div id="upload-area" class="mb-3">
                    <div id="upload-text">
                        <i class="bi bi-cloud-arrow-up fs-1"></i>
                        <p class="mb-0">PDF dosyasını seçmek için tıklayın veya sürükleyip bırakın</p>
                    </div>
                    <div id="loading" class="hidden">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <p class="mb-0 mt-2">PDF işleniyor, lütfen bekleyin...</p>
                    </div>
                </div>
                <input type="file" id="pdf-file" accept=".pdf" class="hidden">
                <p id="error-message" class="text-center hidden"></p>
                <div id="debug-info" class="debug-info"></div>
            </div>
        </div>
        
        <div id="results-container">
            <!-- Sınıf kartları buraya eklenecek -->
        </div>

        <div class="card hidden" id="no-results">
            <div class="card-body text-center">
                <p class="mb-0">Sınıf bilgisi bulunamadı.</p>
            </div>
        </div>
    </div>

    <script>
        // PDF.js kütüphanesinin yüklendiğini kontrol et
        if (typeof pdfjsLib === 'undefined') {
            console.error('PDF.js kütüphanesi yüklenemedi. Sayfa yenilenerek tekrar denenecek...');
            alert('PDF işleme kütüphanesi yüklenemedi. Sayfa yenileniyor...');
            // 3 saniye sonra sayfayı yenile
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            console.log('PDF.js kütüphanesi başarıyla yüklendi!');
        }

        // PDF.js çalışma ortamını yapılandırma
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('pdf-file');
            const loadingElem = document.getElementById('loading');
            const uploadTextElem = document.getElementById('upload-text');
            const resultsContainer = document.getElementById('results-container');
            const noResults = document.getElementById('no-results');
            const errorMessage = document.getElementById('error-message');
            const debugInfo = document.getElementById('debug-info');
            
            let classesByName = {};
            
            // Geliştirme modunda hata ayıklama bilgilerini göster (URL'de ?debug=true parametresi varsa)
            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('debug') === 'true';
            
            if (debugMode) {
                debugInfo.style.display = 'block';
                debugLog('Debug modu aktif');
            }
            
            function debugLog(message, data) {
                console.log(message, data);
                if (debugMode) {
                    let formattedMessage = message;
                    if (data) {
                        if (typeof data === 'object') {
                            formattedMessage += '\n' + JSON.stringify(data, null, 2);
                        } else {
                            formattedMessage += ' ' + data;
                        }
                    }
                    debugInfo.textContent += formattedMessage + '\n';
                    // Otomatik kaydırma
                    debugInfo.scrollTop = debugInfo.scrollHeight;
                }
            }

            // Upload alanına tıklandığında dosya seçimi yapma
            uploadArea.addEventListener('click', () => {
                debugLog('Upload alanına tıklandı');
                fileInput.click();
            });

            // Sürükle-bırak olayları
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                }, false);
            });

            // Dosya sürüklenip bırakıldığında
            uploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                
                debugLog('Dosya bırakıldı:', file ? file.name : 'Dosya yok');
                
                if (file && file.type === 'application/pdf') {
                    fileInput.files = dt.files;
                    processFile(file);
                } else {
                    showError('Lütfen PDF dosyası yükleyin.');
                }
            });

            // Dosya seçildiğinde
            fileInput.addEventListener('change', () => {
                debugLog('Dosya seçme olayı tetiklendi');
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    debugLog('Seçilen dosya:', file.name);
                    
                    if (file.type === 'application/pdf') {
                        processFile(file);
                    } else {
                        showError('Lütfen PDF dosyası yükleyin.');
                    }
                } else {
                    debugLog('Dosya seçilmedi');
                }
            });

            // PDF dosyasını işleme
            async function processFile(file) {
                resetUI();
                showLoading(true);
                
                debugLog('PDF işleme başlatıldı:', file.name);
                
                try {
                    const fileReader = new FileReader();
                    
                    fileReader.onload = async function() {
                        debugLog('Dosya okuma tamamlandı, PDF işleniyor...');
                        const typedArray = new Uint8Array(this.result);
                        
                        try {
                            debugLog('PDF.js ile dosya yükleniyor...');
                            const pdf = await pdfjsLib.getDocument({data: typedArray}).promise;
                            debugLog(`PDF yüklendi, toplam sayfa sayısı: ${pdf.numPages}`);
                            
                            debugLog('Sınıf bilgileri çıkarılıyor...');
                            const classes = await extractClassInfo(pdf);
                            
                            classesByName = classes;
                            
                            const classCount = Object.keys(classes).length;
                            debugLog(`Toplam ${classCount} sınıf bulundu`);
                            
                            if (classCount === 0) {
                                debugLog('Hiç sınıf bulunamadı');
                                noResults.classList.remove('hidden');
                                showLoading(false);
                                return;
                            }
                            
                            debugLog('Sınıflar ve öğrenciler görüntüleniyor...');
                            displayClassesAndStudents(classes);
                            showLoading(false);
                        } catch (err) {
                            console.error('PDF işleme hatası:', err);
                            debugLog('PDF işleme hatası: ' + err.message);
                            showError('PDF dosyası işlenirken bir hata oluştu: ' + err.message);
                            showLoading(false);
                        }
                    };
                    
                    fileReader.onerror = function(err) {
                        debugLog('Dosya okuma hatası: ' + err);
                        showError('Dosya okunamadı.');
                        showLoading(false);
                    };
                    
                    debugLog('Dosya okumaya başlanıyor...');
                    fileReader.readAsArrayBuffer(file);
                } catch (err) {
                    console.error('Dosya okuma hatası:', err);
                    debugLog('Dosya işleme hatası: ' + err.message);
                    showError('Dosya işlenirken hata oluştu: ' + err.message);
                    showLoading(false);
                }
            }
            
            // PDF'den sınıf ve öğrenci bilgilerini çıkarma
            async function extractClassInfo(pdf) {
                const classes = {};
                const numPages = pdf.numPages;
                
                try {
                    for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                        debugLog(`Sayfa ${pageNum}/${numPages} işleniyor...`);
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        debugLog(`Sayfa ${pageNum} - metin öğe sayısı: ${textContent.items.length}`);
                        
                        // 1. Tüm metin içeriğini birleştirme
                        let fullText = '';
                        let prevItem = null;
                        
                        // Kelimeleri birleştirirken yakın olanları kontrol ederek harflerin ayrık olma sorununu gider
                        for (const item of textContent.items) {
                            if (prevItem && 
                                (Math.abs(prevItem.transform[5] - item.transform[5]) < 2) && // Yaklaşık aynı satırda
                                (item.transform[4] - (prevItem.transform[4] + prevItem.width)) < 10) { // Yakın yatay pozisyon
                                // Aradaki boşluk çok küçükse boşluk ekleme (harfler arasındaki boşluk sorunu için)
                                if ((item.transform[4] - (prevItem.transform[4] + prevItem.width)) < 2) {
                                    fullText += item.str;
                                } else {
                                    fullText += ' ' + item.str;
                                }
                            } else {
                                if (prevItem) fullText += '\n';
                                fullText += item.str;
                            }
                            prevItem = item;
                        }
                        
                        // Geliştirme modunda metin içeriğini gösterme
                        if (debugMode) {
                            debugLog(`Sayfa ${pageNum} metin içeriği (ilk 500 karakter):`, fullText.substring(0, 500) + '...');
                        }
                        
                        // 2. Sınıf adını bulma
                        const classNamePattern = /(\d+\.\s*Sınıf\s*\/\s*[A-Z]\s*Şubesi.*?)(?:\n|$)/i;
                        const classMatch = fullText.match(classNamePattern);
                        let currentClass = null;
                        
                        if (classMatch) {
                            currentClass = classMatch[1].trim();
                            debugLog(`Sınıf bulundu: ${currentClass}`);
                            classes[currentClass] = [];
                        } else {
                            debugLog(`Sayfa ${pageNum}'de sınıf bilgisi bulunamadı`);
                        }
                        
                        // 3. Öğrenci bilgilerini bulma ve sınıflandırma
                        const lines = fullText.split('\n');
                        debugLog(`Sayfa ${pageNum} - toplam satır sayısı: ${lines.length}`);
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            
                            // Numara, isim, cinsiyet ve soy isim içeren bir satır arama
                            // Daha esnek bir regex deseni kullanalım
                            const studentPattern = /^\s*(\d+)\s+([A-ZĞÜŞİÖÇÂÎÛa-zğüşıöçâîû\s]+)\s+(Erkek|Kız|erkek|kız)\s+([A-ZĞÜŞİÖÇÂÎÛa-zğüşıöçâîû\s]+)/;
                            const studentMatch = line.match(studentPattern);
                            
                            if (studentMatch && currentClass) {
                                // Harfler arasındaki fazla boşlukları temizle
                                const studentNo = studentMatch[1].trim();
                                const firstName = studentMatch[2].trim().replace(/\s+/g, ' ');
                                const lastName = studentMatch[4].trim().replace(/\s+/g, ' ');
                                
                                classes[currentClass].push({
                                    student_no: studentNo,
                                    first_name: firstName,
                                    last_name: lastName
                                });
                                
                                if (debugMode && classes[currentClass].length <= 3) {
                                    debugLog(`Öğrenci bulundu: ${studentNo} ${firstName} ${lastName}`);
                                }
                            }
                        }
                        
                        if (currentClass) {
                            debugLog(`${currentClass} sınıfında ${classes[currentClass].length} öğrenci bulundu`);
                        }
                    }
                    
                    return classes;
                } catch (err) {
                    debugLog(`PDF işleme hatası: ${err.message}`);
                    throw err;
                }
            }

            // Sınıfları ve öğrencileri görüntüleme
            function displayClassesAndStudents(classes) {
                resultsContainer.innerHTML = '';
                
                Object.entries(classes).forEach(([className, students]) => {
                    if (students.length === 0) return;
                    
                    debugLog(`'${className}' sınıfı görüntüleniyor, ${students.length} öğrenci var`);
                    
                    // Her sınıf için bir kart oluştur
                    const classCard = document.createElement('div');
                    classCard.className = 'card';
                    
                    // Kart başlığı - sınıf adı ve kopyalama butonu
                    const classTitle = document.createElement('div');
                    classTitle.className = 'class-title';
                    classTitle.innerHTML = `
                        ${className}
                        <button class="btn btn-sm btn-outline-primary copy-class-btn" data-class="${className}">
                            Tümünü Kopyala
                        </button>
                    `;
                    
                    // Öğrenci tablosu
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'table-responsive';
                    tableDiv.innerHTML = `
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Öğrenci No</th>
                                    <th>Adı</th>
                                    <th>Soyadı</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-${className.replace(/[^a-z0-9]/gi, '')}"></tbody>
                        </table>
                    `;
                    
                    classCard.appendChild(classTitle);
                    classCard.appendChild(tableDiv);
                    resultsContainer.appendChild(classCard);
                    
                    // Öğrenci listesini doldur
                    const studentList = document.getElementById(`student-list-${className.replace(/[^a-z0-9]/gi, '')}`);
                    
                    students.forEach((student, index) => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${student.student_no}</td>
                            <td>${student.first_name}</td>
                            <td>${student.last_name}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary copy-btn" data-class="${className}" data-field="student_no" data-index="${index}">
                                    <i class="bi bi-clipboard"></i> No
                                </button>
                                <button class="btn btn-sm btn-outline-secondary copy-btn" data-class="${className}" data-field="first_name" data-index="${index}">
                                    <i class="bi bi-clipboard"></i> Ad
                                </button>
                                <button class="btn btn-sm btn-outline-secondary copy-btn" data-class="${className}" data-field="last_name" data-index="${index}">
                                    <i class="bi bi-clipboard"></i> Soyad
                                </button>
                                <button class="btn btn-sm btn-outline-secondary copy-btn" data-class="${className}" data-field="all" data-index="${index}">
                                    <i class="bi bi-clipboard"></i> Tümü
                                </button>
                            </td>
                        `;
                        
                        studentList.appendChild(row);
                    });
                });
                
                // Kopyalama butonları için olay dinleyicileri
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', copyStudentInfo);
                });
                
                // Sınıf kopyalama butonları için olay dinleyicileri
                document.querySelectorAll('.copy-class-btn').forEach(button => {
                    button.addEventListener('click', copyClassInfo);
                });
                
                debugLog('Tüm sınıflar ve öğrenciler başarıyla görüntülendi');
            }

            // Tek bir öğrenci bilgisini kopyalama
            function copyStudentInfo(e) {
                const button = e.currentTarget;
                const field = button.getAttribute('data-field');
                const index = button.getAttribute('data-index');
                const className = button.getAttribute('data-class');
                const student = classesByName[className][index];
                
                let textToCopy = '';
                
                if (field === 'all') {
                    textToCopy = `${student.student_no} ${student.first_name} ${student.last_name}`;
                } else {
                    textToCopy = student[field];
                }
                
                debugLog(`Kopyalanan ${field}: ${textToCopy}`);
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Kopyalama başarılı olduğunda butonun stilini değiştirme
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check"></i> Kopyalandı';
                    button.classList.remove('btn-outline-secondary');
                    button.classList.add('btn-success');
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-secondary');
                    }, 1500);
                }).catch(err => {
                    debugLog('Kopyalama hatası:', err);
                    alert('Kopyalama işlemi başarısız oldu. Tarayıcı izinlerinizi kontrol edin.');
                });
            }

            // Bir sınıfın tüm öğrenci bilgilerini kopyalama
            function copyClassInfo(e) {
                const button = e.currentTarget;
                const className = button.getAttribute('data-class');
                const students = classesByName[className];
                
                let allText = '';
                
                students.forEach(student => {
                    allText += `${student.student_no} ${student.first_name} ${student.last_name}\n`;
                });
                
                debugLog(`'${className}' sınıfının tüm öğrencileri kopyalandı`);
                
                navigator.clipboard.writeText(allText.trim()).then(() => {
                    const originalText = button.textContent;
                    button.textContent = 'Kopyalandı!';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-success');
                    
                    setTimeout(() => {
                        button.textContent = 'Tümünü Kopyala';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-primary');
                    }, 1500);
                }).catch(err => {
                    debugLog('Kopyalama hatası:', err);
                    alert('Kopyalama işlemi başarısız oldu. Tarayıcı izinlerinizi kontrol edin.');
                });
            }

            // UI yardımcı fonksiyonları
            function showLoading(isLoading) {
                if (isLoading) {
                    loadingElem.classList.remove('hidden');
                    uploadTextElem.classList.add('hidden');
                } else {
                    loadingElem.classList.add('hidden');
                    uploadTextElem.classList.remove('hidden');
                }
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                debugLog('Hata mesajı gösteriliyor:', message);
                
                setTimeout(() => {
                    errorMessage.classList.add('hidden');
                }, 5000);
            }
            
            function resetUI() {
                errorMessage.classList.add('hidden');
                resultsContainer.innerHTML = '';
                noResults.classList.add('hidden');
            }
            
            // CSV dosyası oluşturma ve indirme yardımcı fonksiyonu
            window.downloadClassCSV = function(className) {
                const students = classesByName[className];
                let csvContent = 'Öğrenci No,Adı,Soyadı\n';
                
                students.forEach(student => {
                    csvContent += `${student.student_no},${student.first_name},${student.last_name}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${className.replace(/[^a-z0-9]/gi, '_')}_ogrenci_listesi.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                debugLog(`'${className}' sınıfı için CSV indirildi`);
            };
            
            // Sayfanın yüklenmesinin tamamlandığını logla
            debugLog('Sayfa tamamen yüklendi, uygulama kullanıma hazır');
        });
    </script>
</body>
</html> 